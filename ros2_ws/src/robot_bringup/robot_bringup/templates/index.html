<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Camera Stream</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e8e8e8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1 { 
            margin-bottom: 30px; 
            color: orange;
            text-align: center;
            font-size: 3rem;
            font-weight: 600;
            letter-spacing: -0.025em;
            text-shadow: 1px 1px 6px rgba(0,0,0,0.7);
        }
        
        #video-container { 
            position: relative; 
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            background: #2a2a2a;
            padding: 8px;
        }
        
        #video-stream { 
            width: 800px; 
            height: 600px; 
            border-radius: 8px;
            display: block;
            background: #000;
            border: 1px solid #3a3a3a;
        }
        
        #overlay { 
            position: absolute; 
            top: 18px; 
            left: 18px; 
            color: #10a37f; 
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(8px);
            padding: 10px 14px; 
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace; 
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid rgba(58, 58, 58, 0.6);
            font-weight: 500;
        }
        
        .info-panel {
            background: rgba(42, 42, 42, 0.8);
            backdrop-filter: blur(12px);
            padding: 24px;
            margin: 16px 0;
            border-radius: 12px;
            border: 1px solid rgba(58, 58, 58, 0.3);
            min-width: 420px;
            text-align: left;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .info-panel h2 {
            margin-bottom: 16px;
            color: #f0f0f0;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }
        
        #telemetry { 
            background: rgba(16, 16, 16, 0.9);
            color: #10a37f;
            padding: 16px; 
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace; 
            max-height: 300px; 
            overflow-y: auto; 
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            border: 1px solid rgba(58, 58, 58, 0.3);
        }
        
        #timestamp {
            color: #b0b0b0;
            font-size: 14px;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-weight: 400;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }
        
        .status-connected {
            background-color: #10a37f;
            box-shadow: 0 0 8px rgba(16, 163, 127, 0.5);
        }
        
        .status-disconnected {
            background-color: #ff4444;
            box-shadow: 0 0 8px rgba(255, 68, 68, 0.5);
        }
        
        .status-loading {
            background-color: #ffa500;
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.5);
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(58, 58, 58, 0.2);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #b0b0b0;
            font-size: 14px;
            font-weight: 400;
        }
        
        .info-value {
            color: #e8e8e8;
            font-size: 14px;
            font-weight: 500;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
        }
        
        @media (max-width: 900px) {
            #video-stream {
                width: 90vw;
                max-width: 800px;
                height: auto;
                aspect-ratio: 800/600;
            }
            
            .info-panel {
                min-width: 90vw;
                max-width: 500px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 16px;
            }
            
            #overlay {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .info-panel {
                padding: 20px;
            }
        }
        
        /* Scrollbar styling */
        #telemetry::-webkit-scrollbar {
            width: 6px;
        }
        
        #telemetry::-webkit-scrollbar-track {
            background: rgba(26, 26, 26, 0.5);
            border-radius: 3px;
        }
        
        #telemetry::-webkit-scrollbar-thumb {
            background: rgba(16, 163, 127, 0.6);
            border-radius: 3px;
        }
        
        #telemetry::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 163, 127, 0.8);
        }
        
        /* Firefox scrollbar */
        #telemetry {
            scrollbar-width: thin;
            scrollbar-color: rgba(16, 163, 127, 0.6) rgba(26, 26, 26, 0.5);
        }
    </style>
</head>
<body>
    <h1>Robot Camera Stream</h1>
    
    <div id="video-container">
        <img id="video-stream" src="/video" alt="Camera Stream">
        <div id="overlay">
            <span class="status-indicator status-connected" id="status-dot"></span>
            FPS: <span id="fps">0</span> 
        </div>
    </div>
    
    <div class="info-panel">
        <h2>System Information</h2>
        <div class="info-row">
            <span class="info-label">Timestamp:</span>
            <span class="info-value" id="timestamp">Loading...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Stream Status:</span>
            <span class="info-value" id="stream-status">Connecting...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Resolution:</span>
            <span class="info-value" id="resolution-display">800×600 @ 30fps</span>
        </div>
    </div>

    <script>
        // Utility functions
        const $ = (sel) => document.querySelector(sel);
        
        // Global state
        let streamConnected = false;
        let telemetryErrors = 0;
        let cameraConfig = {
            width: 800,
            height: 600,
            fps: 30
        };
        
        // Update timestamp every second
        function updateTimestamp() {
            try {
                const now = new Date();
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                $("#timestamp").innerText = now.toLocaleString('en-GB', options);
            } catch (e) {
                $("#timestamp").innerText = new Date().toLocaleString();
            }
        }
        
        // Start timestamp updates
        setInterval(updateTimestamp, 1000);
        updateTimestamp();
        
        // Update status indicator
        function updateStatusIndicator(connected) {
            const dot = $("#status-dot");
            const status = $("#stream-status");
            
            if (connected) {
                dot.className = "status-indicator status-connected";
                status.innerText = "Connected";
            } else {
                dot.className = "status-indicator status-disconnected";
                status.innerText = "Disconnected";
            }
        }
        
        // Update camera configuration display
        function updateCameraConfig(config) {
            cameraConfig = { ...cameraConfig, ...config };
            const resolutionEl = $("#resolution-display");
            if (resolutionEl) {
                resolutionEl.innerText = `${cameraConfig.width}×${cameraConfig.height} @ ${cameraConfig.fps}fps`;
            }
            
            // Update video element size if needed
            const videoEl = $("#video-stream");
            if (videoEl) {
                videoEl.style.width = `${cameraConfig.width}px`;
                videoEl.style.height = `${cameraConfig.height}px`;
            }
        }
        
        // Telemetry fetching
        async function fetchTelemetry() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const r = await fetch("/api/telemetry", {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                
                const data = await r.json();
                
                // Update overlay data
                $("#fps").textContent = data.fps?.toFixed(1) || "0";
                
                // Update camera configuration if available
                if (data.configured_resolution) {
                    updateCameraConfig({
                        width: data.configured_resolution.width,
                        height: data.configured_resolution.height,
                        fps: data.target_fps
                    });
                }
                
                // Reset error counter on success
                telemetryErrors = 0;
                
                // Update connection status
                if (!streamConnected) {
                    streamConnected = true;
                    updateStatusIndicator(true);
                }
                
            } catch (e) {
                telemetryErrors++;
                
                let errorMsg = `Telemetry error (${telemetryErrors}): `;
                
                if (e.name === 'AbortError') {
                    errorMsg += "Request timeout - server may be busy";
                } else {
                    errorMsg += e.message;
                }
                
                // Update connection status
                if (streamConnected) {
                    streamConnected = false;
                    updateStatusIndicator(false);
                }
                
                // If too many errors, slow down polling
                if (telemetryErrors > 5) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
        
        // Start telemetry polling
        const telemetryInterval = setInterval(fetchTelemetry, 500);
        fetchTelemetry();
        
        // Video stream handling
        const videoElement = $("#video-stream");
        const streamStatusEl = $("#stream-status");
        
        videoElement.addEventListener("load", function() {
            console.log("Video stream loaded successfully");
            streamConnected = true;
            updateStatusIndicator(true);
        });
        
        videoElement.addEventListener("error", function() {
            console.log("Video stream error, attempting to reload...");
            streamConnected = false;
            updateStatusIndicator(false);
            
            // Wait a bit before retrying
            setTimeout(() => {
                const timestamp = new Date().getTime();
                this.src = "/video?" + timestamp;
            }, 2000);
        });
        
        videoElement.addEventListener("abort", function() {
            console.log("Video stream aborted");
            streamConnected = false;
            updateStatusIndicator(false);
        });
        
        // Check stream health periodically
        setInterval(() => {
            if (!streamConnected && telemetryErrors > 3) {
                console.log("Attempting to reconnect video stream...");
                const timestamp = new Date().getTime();
                videoElement.src = "/video?" + timestamp;
            }
        }, 10000);
        
        // Page visibility handling
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                console.log("Page hidden, reducing update frequency");
                clearInterval(telemetryInterval);
            } else {
                console.log("Page visible, resuming normal updates");
                fetchTelemetry();
                setInterval(fetchTelemetry, 500);
            }
        });
        
        // Set initial status
        $("#status-dot").className = "status-indicator status-loading";
        $("#stream-status").innerText = "Connecting...";
        
        // Performance monitoring
        let frameCount = 0;
        setInterval(() => {
            frameCount++;
            if (frameCount % 120 === 0) { // Every 120 intervals (60 seconds)
                console.log(`Performance: ${frameCount} telemetry updates, Stream: ${streamConnected ? 'Connected' : 'Disconnected'}`);
            }
        }, 500);
    </script>
</body>
</html>